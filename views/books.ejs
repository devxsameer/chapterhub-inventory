<!DOCTYPE html>
<html lang="en">
  <%- include("partials/head") %>
  <body
    class="h-screen flex flex-col bg-neutral-200 font-outfit overflow-y-auto"
  >
    <%- include("partials/header") %>

    <div class="flex pt-12 h-full">
      <%- include("partials/sidebar") %>

      <div class="xl:ml-64 flex-1">
        <main class="bg-neutral-50">
          <div class="bg-neutral-200 p-4 z-30 sticky top-12">
            <h2 class="text-4xl font-semibold mb-2">Books</h2>
            <a href="/books/new" class="btn">Add Book</a>
          </div>
          <form
            method="GET"
            class="flex flex-col items-start gap-2 accent-teal-700 border-b p-4 border-neutral-400"
          >
            <input
              type="hidden"
              name="search"
              placeholder="Search title..."
              value="<%= query.search || '' %>"
              class="border p-2 rounded bg-white w-64"
            />
            <div>
              <p class="font-semibold text-sm text-neutral-700 mb-2">
                Filter by Genre:
              </p>

              <div class="flex flex-wrap gap-4">
                <% genres.forEach(g => { %>
                <label class="flex items-center gap-2 cursor-pointer">
                  <input type="checkbox" name="genre" value="<%= g.id %>"
                  onchange="this.form.submit()" <%= Array.isArray(query.genre)
                  && query.genre.includes(String(g.id)) ? "checked" : "" %> />
                  <span class="text-sm text-neutral-800"> <%= g.name %> </span>
                </label>
                <% }) %>
              </div>
            </div>

            <!-- Sort -->
            <div>
              <p class="font-semibold text-sm text-neutral-700 mb-2">
                Sort by:
              </p>
              <div class="flex flex-wrap gap-4">
                <% const options = [ { value: "title_asc", label: "Title A-Z" },
                { value: "title_desc", label: "Title Z-A" }, { value:
                "year_desc", label: "Newest" }, { value: "year_asc", label:
                "Oldest" }, { value: "price_asc", label: "Price Low → High" }, {
                value: "price_desc", label: "Price High → Low" }, ];
                options.forEach((opt) => { const isSelected = query?.sort ?
                String(query.sort) === opt.value : "title_asc" === opt.value %>
                <label
                  for="<%= opt.value %>"
                  class="text-sm gap-2 flex items-center"
                >
                  <input type="radio" id="<%= opt.value %>" name="sort" <%=
                  isSelected ? 'checked' : '' %> value="<%= opt.value %>"
                  onchange="this.form.submit()" /> <%= opt.label %>
                </label>
                <% }) %>
              </div>
            </div>

            <button
              class="hidden bg-purple-500 text-white mt-2 px-3 py-1 rounded"
              aria-hidden="true"
            >
              Apply
            </button>
          </form>
          <div class="p-4">
            <% if (books.length === 0) { %>
            <p class="text-neutral-600">No books found.</p>
            <% } else { %>
            <ul
              class="grid sm:grid-cols-2 items-start md:grid-cols-3 xl:grid-cols-4 gap-4"
            >
              <% books.forEach(book => { %>
              <li class="mb-10 relative">
                <div
                  class="relative z-20 p-4 bg-white rounded-lg shadow-md flex gap-4"
                >
                  <div class="w-48 min-h-28">
                    <img
                      src="<%= book?.image_url || '/img/fallback_book.png' %>"
                      alt="<%= book.title %>"
                      loading="lazy"
                      class="w-full rounded"
                      onerror="this.onerror=null; this.src='/images/fallback_book.png';"
                    />
                  </div>
                  <div>
                    <h4 class="font-semibold text-lg"><%= book.title %></h4>
                    <p class="text-sm text-neutral-600">
                      <%= book.author ? book.author + " • " : "" %> <%=
                      book.year ? book.year + " • " : "" %> <%= book.genre_name
                      ? book.genre_name : "No genre" %>
                    </p>
                    <% if (book.description) { %>
                    <p class="mt-2 text-sm text-neutral-700">
                      <%= book.description %>
                    </p>
                    <% } %>
                  </div>
                </div>
                <div class="z-10 absolute right-2 top-full">
                  <a
                    href="/books/<%= book.id %>/edit"
                    class="btn rounded-t-none"
                    >Edit</a
                  >
                  <a
                    href="/books/<%= book.id %>/delete"
                    class="btn rounded-t-none bg-red-700"
                    >Delete</a
                  >
                </div>
              </li>
              <% }) %>
            </ul>
            <% } %>
          </div>
        </main>

        <%- include("partials/footer") %>
      </div>
    </div>
    <script src="/js/sidebar.js"></script>
  </body>
</html>
