<!DOCTYPE html>
<html lang="en">
  <%- include("partials/head") %>
  <body
    class="h-screen flex flex-col bg-neutral-200 font-outfit overflow-y-auto"
  >
    <%- include("partials/header") %>

    <div class="flex pt-12 h-full">
      <%- include("partials/sidebar") %>

      <div class="ml-64 flex-1">
        <main class="bg-neutral-50">
          <div class="bg-neutral-200 p-4 mb-4 sticky top-12">
            <h2 class="text-4xl font-semibold mb-2">Books</h2>
            <a
              href="/books/new"
              class="text-sm bg-purple-500 px-3 py-1 rounded shadow text-white"
              >Add Book</a
            >
            <form
              method="GET"
              class="flex flex-col items-start gap-2 mt-6 accent-purple-600"
            >
              <input
                type="hidden"
                name="search"
                placeholder="Search title..."
                value="<%= query.search || '' %>"
                class="border p-2 rounded bg-white w-64"
              />
              <div>
                <p class="font-semibold text-sm text-neutral-700 mb-2">
                  Filter by Genre:
                </p>

                <div class="flex flex-wrap gap-4">
                  <% genres.forEach(g => { %>
                  <label class="flex items-center gap-2 cursor-pointer">
                    <input type="checkbox" name="genre" value="<%= g.id %>"
                    onchange="this.form.submit()" <%= Array.isArray(query.genre)
                    && query.genre.includes(String(g.id)) ? "checked" : "" %> />
                    <span class="text-sm text-neutral-800">
                      <%= g.name %>
                    </span>
                  </label>
                  <% }) %>
                </div>
              </div>

              <!-- Sort -->
              <div>
                <p class="font-semibold text-sm text-neutral-700 mb-2">
                  Sort by:
                </p>
                <div class="flex flex-wrap gap-4">
                  <% const options = [ { value: "title_asc", label: "Title A-Z"
                  }, { value: "title_desc", label: "Title Z-A" }, { value:
                  "year_desc", label: "Newest" }, { value: "year_asc", label:
                  "Oldest" }, { value: "price_asc", label: "Price Low → High" },
                  { value: "price_desc", label: "Price High → Low" }, ];
                  options.forEach((opt) => { const isSelected = query?.sort ?
                  String(query.sort) === opt.value : "title_asc" === opt.value
                  %>
                  <label
                    for="<%= opt.value %>"
                    class="text-sm gap-2 flex items-center"
                  >
                    <input type="radio" id="<%= opt.value %>" name="sort" <%=
                    isSelected ? 'checked' : '' %> value="<%= opt.value %>"
                    onchange="this.form.submit()" /> <%= opt.label %>
                  </label>
                  <% }) %>
                </div>
              </div>

              <button
                class="hidden bg-purple-500 text-white mt-2 px-3 py-1 rounded"
                aria-hidden="true"
              >
                Apply
              </button>
            </form>
          </div>

          <div class="p-4">
            <% if (books.length === 0) { %>
            <p class="text-neutral-600">No books found.</p>
            <% } else { %>
            <ul class="grid grid-cols-3 gap-4">
              <% books.forEach(book => { %>
              <li class="p-4 bg-white rounded-lg shadow flex gap-4">
                <div class="w-48 min-h-48">
                  <% if (book.image_url) { %>
                  <img
                    src="<%= book.image_url %>"
                    alt="<%= book.title %>"
                    loading="lazy"
                    class="w-full rounded"
                  />
                  <% } %>
                </div>
                <div>
                  <div>
                    <h4 class="font-semibold text-lg"><%= book.title %></h4>
                    <p class="text-sm text-neutral-600">
                      <%= book.author ? book.author + " • " : "" %> <%=
                      book.year ? book.year + " • " : "" %> <%= book.genre_name
                      ? book.genre_name : "No genre" %>
                    </p>
                    <% if (book.description) { %>
                    <p class="mt-2 text-sm text-neutral-700">
                      <%= book.description %>
                    </p>
                    <% } %>
                  </div>

                  <div class="space-x-3">
                    <a
                      href="/books/<%= book.id %>/edit"
                      class="text-blue-600 underline"
                      >Edit</a
                    >
                    <a
                      href="/books/<%= book.id %>/delete"
                      class="text-red-600 underline"
                      >Delete</a
                    >
                  </div>
                </div>
              </li>
              <% }) %>
            </ul>
            <% } %>
          </div>
        </main>

        <%- include("partials/footer") %>
      </div>
    </div>
  </body>
</html>
